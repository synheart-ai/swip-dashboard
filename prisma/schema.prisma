generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?
  createdAt     DateTime  @default(now())
  emailVerified Boolean   @default(false)
  image         String?
  isDeveloper   Boolean   @default(false)
  updatedAt     DateTime  @default(now()) @updatedAt
  apiKeys       ApiKey[]
  apps          App[]
  accounts      Account[]
  sessions      Session[]

  @@index([email])
  @@index([createdAt])
  @@index([isDeveloper])
  @@map("user")
}

model App {
  id                   String                @id @default(cuid())
  name                 String
  category             String?               // App category (Health, Communication, Game, Entertainment)
  description          String?               // App description
  os                   String?               // Operating system: android, ios, web
  appId                String?               // Package name (Android) or Bundle ID (iOS) - for claiming
  appVersion           String?               // App version
  developer            String?               // Developer/company name
  iconUrl              String?               // App icon URL from store

  // Ownership (null if created by SWIP App until claimed)
  ownerId              String?

  // Source tracking
  createdVia           String                @default("portal")  // "portal" or "swip_app"
  claimable            Boolean               @default(false)     // true if created by SWIP App (not yet claimed)
  claimedAt            DateTime?             // When developer claimed this app

  avgSwipScore         Float?                // Rolling average SWIP score
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now()) @updatedAt

  // Relations
  owner                User?                 @relation(fields: [ownerId], references: [id])
  apiKeys              ApiKey[]
  leaderboardSnapshots LeaderboardSnapshot[]
  appSessions          AppSession[]          // SWIP App sessions

  @@index([ownerId])
  @@index([appId])
  @@index([category])
  @@index([avgSwipScore])
  @@index([createdVia])
  @@index([claimable])
  @@index([createdAt])
}

model ApiKey {
  id         String    @id @default(cuid())
  keyHash    String    // Bcrypt hash of the API key
  lookupHash String    @unique // SHA-256 hash for fast lookups
  preview    String    // First 10 characters for display
  appId      String
  userId     String
  createdAt  DateTime  @default(now())
  revoked    Boolean   @default(false)
  lastUsed   DateTime?
  app        App       @relation(fields: [appId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@index([lookupHash])
  @@index([appId])
  @@index([userId])
  @@index([revoked])
  @@index([lastUsed])
}


model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_session")
}

model LeaderboardSnapshot {
  id        String   @id @default(cuid())
  appId     String
  avgScore  Float
  sessions  Int
  window    String
  createdAt DateTime @default(now())
  app       App      @relation(fields: [appId], references: [id])

  @@unique([appId, window])
  @@index([avgScore])
  @@index([window])
  @@index([createdAt])
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model ApiCallLog {
  id            String   @id @default(cuid())
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int      // in milliseconds
  userId        String?
  appId         String?
  ipAddress     String?
  userAgent     String?
  region        String?  // Geographic region (North America, Europe, etc.)
  devicePlatform String? // Device platform (iOS, Android, Web, etc.)
  createdAt     DateTime @default(now())

  @@index([endpoint])
  @@index([method])
  @@index([statusCode])
  @@index([createdAt])
  @@index([userId])
  @@index([appId])
  @@index([region])
  @@index([devicePlatform])
}

model SystemUptime {
  id          String   @id @default(cuid())
  serviceName String
  isUp        Boolean
  responseTime Int?    // in milliseconds
  errorMessage String?
  createdAt   DateTime @default(now())

  @@index([serviceName])
  @@index([isUp])
  @@index([createdAt])
}

// ==========================================
// SWIP APP INTEGRATION (New Tables)
// ==========================================

// Device information
model Device {
  id              String        @id @default(cuid())
  deviceId        String        @unique  // External device ID from SWIP App
  platform        String?                // iOS, Android, etc.
  watchModel      String?                // e.g., "Apple Watch Series 11"
  mobileOsVersion String?                // e.g., "iOS 26"
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  sessions        AppSession[]

  @@index([deviceId])
  @@index([platform])
  @@index([createdAt])
}

// App Sessions from SWIP App
model AppSession {
  id              String        @id @default(cuid())
  appSessionId    String        @unique  // External session ID from SWIP App
  appInternalId   String                 // Links to App.id
  userId          String?                // Anonymized user identifier
  deviceId        String?                // Device identifier (links to Device.deviceId)
  startedAt       DateTime               // Session start time
  endedAt         DateTime?              // Session end time
  dataOnCloud     Int           @default(0)  // 0 or 1, cloud storage flag
  avgSwipScore    Float?                 // Average SWIP score for this session
  duration        Int?                   // Session duration in seconds
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  app             App           @relation(fields: [appInternalId], references: [id])
  device          Device?       @relation(fields: [deviceId], references: [deviceId])
  biosignals      AppBiosignal[]

  @@index([appSessionId])
  @@index([appInternalId])
  @@index([userId])
  @@index([deviceId])
  @@index([startedAt])
  @@index([avgSwipScore])
  @@index([createdAt])
}

// Biosignals from wearables
model AppBiosignal {
  id                      String      @id @default(cuid())
  appBiosignalId          String      @unique  // External biosignal ID
  appSessionId            String                // Reference to AppSession.appSessionId
  timestamp               DateTime              // Measurement timestamp

  // Physiological metrics
  respiratoryRate         Float?                // Breaths per minute
  hrvSdnn                 Float?                // HRV SDNN (ms)
  heartRate               Int?                  // Beats per minute
  accelerometer           Json?                 // Accelerometer reading [x, y, z] in m/s²
  temperature             Float?                // Body temperature (°C)
  bloodOxygenSaturation   Float?                // SpO2 (%)
  ecg                     Float?                // ECG reading
  emg                     Float?                // EMG reading
  eda                     Float?                // Electrodermal activity
  gyro                    Json?                 // Gyroscope data [x, y, z]
  ppg                     Float?                // Photoplethysmogram
  ibi                     Float?                // Inter-beat interval (ms)

  createdAt               DateTime    @default(now())

  // Relations
  session                 AppSession  @relation(fields: [appSessionId], references: [appSessionId])
  emotions                Emotion[]

  @@index([appBiosignalId])
  @@index([appSessionId])
  @@index([timestamp])
  @@index([heartRate])
  @@index([hrvSdnn])
  @@index([createdAt])
}

// AI-detected emotions
model Emotion {
  id                String        @id @default(cuid())
  emotionId         Int?          // Original emotion ID from SWIP App
  appBiosignalId    String                      // Reference to AppBiosignal.appBiosignalId
  swipScore         Float                       // Computed SWIP score
  physSubscore      Float         @default(0)  // Physical component score
  emoSubscore       Float         @default(0)  // Emotional component score
  confidence        Float                       // Model confidence (0-1)
  dominantEmotion   String                      // calm, stressed, anxious, happy, neutral, sad, focused, excited, Amused
  modelId           String                      // AI model identifier (e.g., wesad_emotion_v1_0)
  createdAt         DateTime      @default(now())

  // Relations
  biosignal         AppBiosignal  @relation(fields: [appBiosignalId], references: [appBiosignalId])

  @@index([emotionId])
  @@index([appBiosignalId])
  @@index([dominantEmotion])
  @@index([swipScore])
  @@index([modelId])
  @@index([createdAt])
}
